{
  "project_name": "Telegram Dual Bot Payment System",
  "project_description": "Há»‡ thá»‘ng 2 bot Telegram (Client + Admin) tÃ­ch há»£p Laravel backend, USDT payment gateway tá»± Ä‘á»™ng, vÃ  admin approval workflow",
  "tech_stack": {
    "backend": "Laravel 12",
    "database": "MySQL 8.0",
    "cache": "Redis",
    "queue": "Laravel Queue with Redis",
    "telegram_sdk": "irazasyed/telegram-bot-sdk",
    "payment": "USDT (TRC20) via API Gateway"
  },
  
  "prompts": [
    {
      "step": 1,
      "title": "Khá»Ÿi táº¡o Project Laravel & Database Schema",
      "prompt": "Táº¡o má»™t project Laravel 12 má»›i vá»›i tÃªn 'telegram-payment-system'. Cáº¥u hÃ¬nh database MySQL vá»›i cÃ¡c báº£ng sau:\n\n1. **customers**: LÆ°u thÃ´ng tin khÃ¡ch hÃ ng tá»« Telegram\n   - id (primary key)\n   - telegram_chat_id (unique, string)\n   - telegram_username (nullable, string)\n   - telegram_first_name (nullable, string)\n   - telegram_last_name (nullable, string)\n   - balance (decimal 10,2, default 0)\n   - is_verified (boolean, default false)\n   - created_at, updated_at\n\n2. **transactions**: LÆ°u cÃ¡c giao dá»‹ch\n   - id (primary key)\n   - customer_id (foreign key -> customers.id)\n   - code (unique, string) - MÃ£ khÃ¡ch hÃ ng nháº­p vÃ o\n   - status (enum: pending, payment_required, payment_confirmed, admin_review, approved, rejected)\n   - amount (decimal 10,2) - Sá»‘ tiá»n giao dá»‹ch\n   - usdt_tx_hash (nullable, string) - Transaction hash USDT\n   - data (text, nullable) - Dá»¯ liá»‡u tráº£ vá» cho client (JSON)\n   - paid_at (timestamp, nullable)\n   - approved_at (timestamp, nullable)\n   - rejected_at (timestamp, nullable)\n   - admin_note (text, nullable)\n   - created_at, updated_at\n\n3. **payments**: LÆ°u thÃ´ng tin thanh toÃ¡n USDT\n   - id (primary key)\n   - customer_id (foreign key -> customers.id)\n   - transaction_id (foreign key -> transactions.id, nullable)\n   - payment_address (string) - Äá»‹a chá»‰ vÃ­ nháº­n\n   - amount (decimal 10,2)\n   - tx_hash (string, nullable) - Hash giao dá»‹ch blockchain\n   - status (enum: pending, confirmed, failed)\n   - confirmed_at (timestamp, nullable)\n   - created_at, updated_at\n\n4. **admin_actions**: Log hÃ nh Ä‘á»™ng admin\n   - id (primary key)\n   - admin_telegram_id (string)\n   - transaction_id (foreign key -> transactions.id)\n   - action (enum: approved, rejected)\n   - note (text, nullable)\n   - created_at\n\nTáº¡o migrations, models vá»›i relationships, vÃ  seeders máº«u.",
      "expected_output": [
        "Laravel project structure Ä‘áº§y Ä‘á»§",
        "Migration files cho 4 tables",
        "Models: Customer, Transaction, Payment, AdminAction",
        "Relationships: hasMany, belongsTo",
        "Seeders vá»›i dá»¯ liá»‡u test"
      ]
    },
    
    {
      "step": 2,
      "title": "CÃ i Äáº·t & Cáº¥u HÃ¬nh Telegram Bot SDK",
      "prompt": "CÃ i Ä‘áº·t package 'irazasyed/telegram-bot-sdk' vÃ  cáº¥u hÃ¬nh 2 bot Telegram:\n\n1. Client Bot:\n   - Token: Láº¥y tá»« .env (TELEGRAM_CLIENT_BOT_TOKEN)\n   - Webhook URL: /api/telegram/client/webhook\n   - Commands há»— trá»£: /start, /balance, /history\n\n2. Admin Bot:\n   - Token: Láº¥y tá»« .env (TELEGRAM_ADMIN_BOT_TOKEN)\n   - Admin Chat ID: Láº¥y tá»« .env (TELEGRAM_ADMIN_CHAT_ID)\n   - Webhook URL: /api/telegram/admin/webhook\n\nTáº¡o service classes:\n- TelegramClientService: Xá»­ lÃ½ logic client bot\n- TelegramAdminService: Xá»­ lÃ½ logic admin bot\n\nTáº¡o middleware VerifyTelegramWebhook Ä‘á»ƒ xÃ¡c thá»±c webhook tá»« Telegram.\n\nThÃªm vÃ o .env:\nTELEGRAM_CLIENT_BOT_TOKEN=your_client_token\nTELEGRAM_ADMIN_BOT_TOKEN=your_admin_token\nTELEGRAM_ADMIN_CHAT_ID=your_admin_chat_id",
      "expected_output": [
        "composer.json updated vá»›i telegram-bot-sdk",
        "config/telegram.php configuration file",
        "Services: TelegramClientService.php, TelegramAdminService.php",
        "Middleware: VerifyTelegramWebhook.php",
        "Routes trong api.php cho webhooks"
      ]
    },
    
    {
      "step": 3,
      "title": "XÃ¢y Dá»±ng Client Bot Controller & Logic",
      "prompt": "Táº¡o ClientBotController vá»›i cÃ¡c chá»©c nÄƒng:\n\n**1. Xá»­ lÃ½ lá»‡nh /start:**\n- Táº¡o hoáº·c láº¥y customer tá»« database báº±ng telegram_chat_id\n- LÆ°u thÃ´ng tin: username, first_name, last_name\n- Gá»­i message chÃ o má»«ng vá»›i hÆ°á»›ng dáº«n sá»­ dá»¥ng\n- Format: \"ğŸ‘‹ ChÃ o má»«ng {name}!\\n\\nVui lÃ²ng nháº­p mÃ£ Ä‘á»ƒ sá»­ dá»¥ng dá»‹ch vá»¥.\\nVÃ­ dá»¥: ABC123\\n\\nğŸ’° Sá»‘ dÆ° hiá»‡n táº¡i: {balance} USDT\"\n\n**2. Xá»­ lÃ½ lá»‡nh /balance:**\n- Hiá»ƒn thá»‹ sá»‘ dÆ° USDT hiá»‡n táº¡i\n- Hiá»ƒn thá»‹ sá»‘ giao dá»‹ch Ä‘Ã£ hoÃ n thÃ nh\n\n**3. Xá»­ lÃ½ lá»‡nh /history:**\n- Hiá»ƒn thá»‹ 10 giao dá»‹ch gáº§n nháº¥t\n- Format: \"ğŸ“‹ Lá»‹ch sá»­ giao dá»‹ch\\n\\n\" + danh sÃ¡ch vá»›i mÃ£, tráº¡ng thÃ¡i, sá»‘ tiá»n, thá»i gian\n\n**4. Xá»­ lÃ½ nháº­p mÃ£ (text message):**\n- Validate mÃ£ (alphanumeric, 6-20 kÃ½ tá»±)\n- Kiá»ƒm tra customer Ä‘Ã£ cÃ³ giao dá»‹ch approved trÆ°á»›c Ä‘Ã³ chÆ°a\n- Táº¡o transaction má»›i vá»›i status 'pending'\n\n**Náº¿u khÃ¡ch hÃ ng Má»šI (chÆ°a cÃ³ giao dá»‹ch approved):**\n- Set transaction status = 'payment_required'\n- Gá»i PaymentService->generatePaymentRequest()\n- Gá»­i message yÃªu cáº§u náº¡p USDT vá»›i:\n  - Sá»‘ tiá»n cáº§n náº¡p (default: 10 USDT)\n  - Äá»‹a chá»‰ vÃ­ nháº­n (TRC20)\n  - HÆ°á»›ng dáº«n thanh toÃ¡n\n  - Message: \"ğŸ’° YÃŠU Cáº¦U Náº P TIá»€N\\n\\nSá»‘ tiá»n: {amount} USDT (TRC20)\\nÄá»‹a chá»‰ vÃ­: `{address}`\\n\\nâš ï¸ Chá»‰ chuyá»ƒn USDT TRC20!\\nâ³ Há»‡ thá»‘ng sáº½ tá»± Ä‘á»™ng xÃ¡c nháº­n sau 1-2 phÃºt.\"\n\n**Náº¿u khÃ¡ch hÃ ng CÅ¨ (Ä‘Ã£ cÃ³ giao dá»‹ch approved):**\n- Set transaction status = 'admin_review'\n- Gá»­i message: \"âœ… ÄÃ£ nháº­n mÃ£: {code}\\n\\nâ³ Äang chá» admin xÃ¡c nháº­n...\\nğŸ’° Sá»‘ dÆ°: {balance} USDT\"\n- Trigger job NotifyAdminForApproval\n\nXá»­ lÃ½ callback queries (buttons) náº¿u cÃ³.",
      "expected_output": [
        "ClientBotController.php vá»›i Ä‘áº§y Ä‘á»§ methods",
        "Validation rules cho input",
        "Integration vá»›i Customer model",
        "Integration vá»›i Transaction model",
        "Error handling Ä‘áº§y Ä‘á»§"
      ]
    },
    
    {
      "step": 4,
      "title": "XÃ¢y Dá»±ng USDT Payment Integration",
      "prompt": "Táº¡o PaymentService vÃ  PaymentWebhookController Ä‘á»ƒ xá»­ lÃ½ thanh toÃ¡n USDT tá»± Ä‘á»™ng:\n\n**PaymentService:**\n\n1. Method generatePaymentRequest($transaction):\n   - Táº¡o payment record má»›i\n   - Generate unique payment address hoáº·c sá»­ dá»¥ng address cá»‘ Ä‘á»‹nh vá»›i memo\n   - Gá»i API cá»§a payment gateway Ä‘á»ƒ táº¡o payment session\n   - Return payment address vÃ  amount\n\n2. Method checkPaymentStatus($paymentId):\n   - Query API gateway Ä‘á»ƒ check tráº¡ng thÃ¡i\n   - Return status: pending/confirmed/failed\n\n3. Method confirmPayment($payment, $txHash):\n   - Update payment status = 'confirmed'\n   - Update payment tx_hash\n   - Cá»™ng tiá»n vÃ o customer balance\n   - Update transaction liÃªn quan: status = 'payment_confirmed'\n   - Trigger notification Ä‘áº¿n client\n   - Trigger job NotifyAdminForApproval\n\n**PaymentWebhookController:**\n\n1. Method handle(Request $request):\n   - Verify webhook signature (HMAC SHA256)\n   - Extract data: tx_hash, amount, address, status\n   - Find payment record by address\n   - Validate amount matches\n   - Call PaymentService->confirmPayment()\n   - Send Telegram message to client: \"âœ… Náº¡p tiá»n thÃ nh cÃ´ng!\\n\\nSá»‘ tiá»n: {amount} USDT\\nTX Hash: {hash}\\nğŸ’° Sá»‘ dÆ° má»›i: {balance} USDT\\n\\nâ³ Äang chá» admin xÃ¡c nháº­n yÃªu cáº§u cá»§a báº¡n...\"\n   - Return JSON response {'status': 'ok'}\n\n**Environment Variables:**\n- USDT_PAYMENT_API_URL\n- USDT_PAYMENT_API_KEY\n- USDT_PAYMENT_WEBHOOK_SECRET\n- USDT_WALLET_ADDRESS (Ä‘á»‹a chá»‰ vÃ­ nháº­n)\n\n**Routes:**\n- POST /api/payment/webhook (public, cÃ³ middleware verify signature)\n\n**Security:**\n- Validate webhook signature báº±ng HMAC\n- Rate limiting cho webhook endpoint\n- Log táº¥t cáº£ payment events",
      "expected_output": [
        "PaymentService.php vá»›i 3 methods chÃ­nh",
        "PaymentWebhookController.php",
        "Webhook signature verification",
        "Integration vá»›i Payment model",
        "Logging system cho payments"
      ]
    },
    
    {
      "step": 5,
      "title": "XÃ¢y Dá»±ng Admin Bot Controller & Approval System",
      "prompt": "Táº¡o AdminBotController vá»›i há»‡ thá»‘ng approval:\n\n**Webhook Handler:**\n\n1. Method webhook(Request $request):\n   - Parse Telegram update\n   - Check if has callback_query (button click)\n   - Route to handleCallbackQuery()\n\n**Callback Query Handler:**\n\n1. Method handleCallbackQuery($callbackQuery):\n   - Parse callback_data format: \"approve_{transaction_id}\" hoáº·c \"reject_{transaction_id}\"\n   - Extract action vÃ  transaction_id\n   - Find transaction by ID\n   - Route to approveTransaction() hoáº·c rejectTransaction()\n   - Answer callback query vá»›i Telegram API\n\n**Approve Flow:**\n\n1. Method approveTransaction($transaction, $chatId, $messageId):\n   - Validate transaction status = 'admin_review'\n   - Check customer cÃ³ Ä‘á»§ balance khÃ´ng\n   - Update transaction:\n     - status = 'approved'\n     - approved_at = now()\n   - Trá»« tiá»n customer: balance -= transaction.amount\n   - Create AdminAction log\n   - Update admin message (editMessageText):\n     \"âœ… ÄÃƒ DUYá»†T\\n\\nMÃ£: {code}\\nKhÃ¡ch hÃ ng: @{username}\\nğŸ’° Sá»‘ tiá»n: {amount} USDT\\nâ° Thá»i gian duyá»‡t: {approved_at}\\nğŸ‘¤ Admin: {admin_name}\"\n   - Trigger job SendDataToClient\n\n**Reject Flow:**\n\n1. Method rejectTransaction($transaction, $chatId, $messageId):\n   - Update transaction:\n     - status = 'rejected'\n     - rejected_at = now()\n   - Create AdminAction log\n   - Update admin message:\n     \"âŒ ÄÃƒ Tá»ª CHá»I\\n\\nMÃ£: {code}\\nKhÃ¡ch hÃ ng: @{username}\\nâ° Thá»i gian tá»« chá»‘i: {rejected_at}\\nğŸ‘¤ Admin: {admin_name}\"\n   - Send message to client:\n     \"âŒ YÃŠU Cáº¦U Bá»Š Tá»ª CHá»I\\n\\nMÃ£: {code}\\nâ° Thá»i gian: {rejected_at}\\n\\nğŸ’¬ Vui lÃ²ng liÃªn há»‡ admin Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.\"\n\n**Admin Commands:**\n\n1. /stats - Hiá»ƒn thá»‹ thá»‘ng kÃª:\n   - Tá»•ng giao dá»‹ch hÃ´m nay\n   - Tá»•ng doanh thu\n   - Sá»‘ giao dá»‹ch Ä‘ang chá»\n   - Sá»‘ khÃ¡ch hÃ ng active\n\n2. /pending - Hiá»ƒn thá»‹ danh sÃ¡ch giao dá»‹ch Ä‘ang chá» duyá»‡t",
      "expected_output": [
        "AdminBotController.php Ä‘áº§y Ä‘á»§",
        "Callback query parsing logic",
        "Transaction approval/rejection flow",
        "Admin message formatting",
        "AdminAction logging"
      ]
    },
    
    {
      "step": 6,
      "title": "XÃ¢y Dá»±ng Queue Jobs System",
      "prompt": "Táº¡o cÃ¡c Laravel Queue Jobs Ä‘á»ƒ xá»­ lÃ½ async:\n\n**1. NotifyAdminForApproval Job:**\n- Trigger khi: Transaction status chuyá»ƒn sang 'admin_review'\n- Logic:\n  - Load transaction vá»›i customer relationship\n  - Táº¡o inline keyboard vá»›i 2 buttons:\n    - \"âœ… Duyá»‡t\" -> callback_data: \"approve_{id}\"\n    - \"âŒ Tá»« chá»‘i\" -> callback_data: \"reject_{id}\"\n  - Format message:\n    \"ğŸ”” YÃŠU Cáº¦U Má»šI #{id}\\n\\nğŸ‘¤ KhÃ¡ch hÃ ng: @{username} ({first_name})\\nğŸ“ MÃ£: {code}\\nğŸ’° Sá»‘ tiá»n: {amount} USDT\\nğŸ’³ Sá»‘ dÆ° hiá»‡n táº¡i: {balance} USDT\\nâ° Thá»i gian: {created_at}\\n\\nğŸ“Š Lá»‹ch sá»­:\\n- Tá»•ng giao dá»‹ch: {total_transactions}\\n- ÄÃ£ approved: {approved_count}\\n- ÄÃ£ tá»« chá»‘i: {rejected_count}\"\n  - Send message Ä‘áº¿n admin bot vá»›i keyboard\n  - Update transaction status = 'admin_review'\n\n**2. SendDataToClient Job:**\n- Trigger khi: Transaction Ä‘Æ°á»£c approved\n- Logic:\n  - Load transaction data (JSON field)\n  - Format message vá»›i data:\n    \"âœ… YÃŠU Cáº¦U ÄÃƒ ÄÆ¯á»¢C DUYá»†T\\n\\nğŸ“ MÃ£: {code}\\nğŸ’µ ÄÃ£ trá»«: {amount} USDT\\nğŸ’° Sá»‘ dÆ° cÃ²n láº¡i: {balance} USDT\\nâ° Thá»i gian: {approved_at}\\n\\nğŸ“Š Dá»® LIá»†U Cá»¦A Báº N:\\n{formatted_data}\"\n  - Náº¿u cÃ³ file URL trong data, gá»­i document/photo\n  - Send message Ä‘áº¿n client bot\n\n**3. ProcessPaymentConfirmation Job:**\n- Trigger khi: Payment webhook nháº­n confirmed\n- Logic:\n  - Update payment record\n  - Cá»™ng balance cho customer\n  - Find pending transaction\n  - Update transaction status\n  - Notify client vá» payment success\n  - Trigger NotifyAdminForApproval\n\n**4. CleanupExpiredPayments Job (scheduled):**\n- Cháº¡y má»—i giá»\n- Logic:\n  - Find payments vá»›i status 'pending' > 24h\n  - Update status = 'failed'\n  - Notify customers vá» expired payment\n\n**Queue Configuration:**\n- Queue connection: redis\n- Queue name: telegram-jobs\n- Retry: 3 times\n- Timeout: 60 seconds\n- Failed jobs table cho tracking",
      "expected_output": [
        "4 Job classes trong app/Jobs/",
        "Queue configuration trong queue.php",
        "Failed jobs migration",
        "Scheduled task trong Kernel.php",
        "Job dispatching trong controllers"
      ]
    },
    
    {
      "step": 7,
      "title": "XÃ¢y Dá»±ng Auto-Approve Logic cho KhÃ¡ch CÅ©",
      "prompt": "Implement tÃ­nh nÄƒng tá»± Ä‘á»™ng duyá»‡t cho khÃ¡ch hÃ ng Ä‘Ã£ cÃ³ lá»‹ch sá»­ tá»‘t:\n\n**AutoApprovalService:**\n\n1. Method shouldAutoApprove(Customer $customer): bool\n   - Äiá»u kiá»‡n auto-approve:\n     - CÃ³ Ã­t nháº¥t 3 giao dá»‹ch Ä‘Ã£ approved\n     - KhÃ´ng cÃ³ giao dá»‹ch bá»‹ reject trong 30 ngÃ y gáº§n Ä‘Ã¢y\n     - Balance >= amount cáº§n trá»«\n     - KhÃ´ng cÃ³ giao dá»‹ch Ä‘ang pending khÃ¡c\n   - Return true/false\n\n2. Method autoApprove(Transaction $transaction): void\n   - Update transaction: status = 'approved', approved_at = now()\n   - Trá»« tiá»n customer\n   - Create AdminAction vá»›i note \"Auto-approved by system\"\n   - Trigger SendDataToClient job\n   - Log auto-approval event\n\n**TÃ­ch há»£p vÃ o ClientBotController:**\n\nTrong handleCode() method, sau khi táº¡o transaction cho khÃ¡ch cÅ©:\n\n```php\nif ($previousTransaction) {\n    $transaction->update(['status' => 'admin_review']);\n    \n    // Check auto-approve\n    $autoApprovalService = new AutoApprovalService();\n    if ($autoApprovalService->shouldAutoApprove($customer)) {\n        $autoApprovalService->autoApprove($transaction);\n        \n        $this->telegram->sendMessage([\n            'chat_id' => $chatId,\n            'text' => \"âœ… ÄÃ£ tá»± Ä‘á»™ng xá»­ lÃ½ yÃªu cáº§u cá»§a báº¡n!\\n\\n\"\n                   . \"ğŸ“ MÃ£: {$code}\\n\"\n                   . \"ğŸ’µ ÄÃ£ trá»«: {$transaction->amount} USDT\\n\"\n                   . \"ğŸ’° Sá»‘ dÆ°: {$customer->balance} USDT\\n\\n\"\n                   . \"ğŸ“Š Dá»¯ liá»‡u Ä‘ang Ä‘Æ°á»£c xá»­ lÃ½...\"\n        ]);\n    } else {\n        // Send to admin review\n        dispatch(new NotifyAdminForApproval($transaction));\n        \n        $this->telegram->sendMessage([\n            'chat_id' => $chatId,\n            'text' => \"âœ… ÄÃ£ nháº­n mÃ£: {$code}\\n\\n\"\n                   . \"â³ Äang chá» admin xÃ¡c nháº­n...\"\n        ]);\n    }\n}\n```\n\n**Admin Notification khi Auto-Approve:**\n- Gá»­i message info Ä‘áº¿n admin (khÃ´ng cáº§n approval button):\n  \"â„¹ï¸ Tá»° Äá»˜NG DUYá»†T\\n\\nğŸ‘¤ KhÃ¡ch hÃ ng: @{username}\\nğŸ“ MÃ£: {code}\\nğŸ’° Sá»‘ tiá»n: {amount} USDT\\nâ° Thá»i gian: {now}\\nâœ… LÃ½ do: KhÃ¡ch hÃ ng cÃ³ lá»‹ch sá»­ tá»‘t\"",
      "expected_output": [
        "AutoApprovalService.php vá»›i 2 methods",
        "Integration vÃ o ClientBotController",
        "Auto-approve conditions logic",
        "Notification system cho auto-approval",
        "Logging cho auto-approval events"
      ]
    },
    
    {
      "step": 8,
      "title": "XÃ¢y Dá»±ng API Routes & Security",
      "prompt": "Thiáº¿t láº­p routes, middleware, vÃ  security cho toÃ n bá»™ há»‡ thá»‘ng:\n\n**Routes (routes/api.php):**\n\n```php\nRoute::prefix('telegram')->group(function() {\n    Route::post('/client/webhook', [ClientBotController::class, 'webhook'])\n        ->middleware('verify.telegram:client');\n    \n    Route::post('/admin/webhook', [AdminBotController::class, 'webhook'])\n        ->middleware('verify.telegram:admin');\n    \n    Route::get('/setup', [TelegramSetupController::class, 'setWebhooks'])\n        ->middleware('auth.admin'); // Chá»‰ cháº¡y 1 láº§n\n});\n\nRoute::post('/payment/webhook', [PaymentWebhookController::class, 'handle'])\n    ->middleware('verify.payment.signature');\n```\n\n**Middleware: VerifyTelegramWebhook**\n\n```php\npublic function handle($request, Closure $next, $botType)\n{\n    $token = $botType === 'client' \n        ? config('telegram.bots.client.token')\n        : config('telegram.bots.admin.token');\n    \n    // Verify secret token header\n    $secretToken = $request->header('X-Telegram-Bot-Api-Secret-Token');\n    $expectedToken = hash('sha256', $token);\n    \n    if (!hash_equals($expectedToken, $secretToken ?? '')) {\n        Log::warning('Invalid Telegram webhook', [\n            'ip' => $request->ip(),\n            'bot_type' => $botType\n        ]);\n        abort(403, 'Unauthorized');\n    }\n    \n    return $next($request);\n}\n```\n\n**Middleware: VerifyPaymentSignature**\n\n```php\npublic function handle($request, Closure $next)\n{\n    $signature = $request->header('X-Webhook-Signature');\n    $secret = config('payment.webhook_secret');\n    $payload = $request->getContent();\n    \n    $expectedSignature = hash_hmac('sha256', $payload, $secret);\n    \n    if (!hash_equals($expectedSignature, $signature ?? '')) {\n        Log::warning('Invalid payment webhook', [\n            'ip' => $request->ip()\n        ]);\n        abort(403, 'Invalid signature');\n    }\n    \n    return $next($request);\n}\n```\n\n**Rate Limiting:**\n\n```php\n// app/Providers/RouteServiceProvider.php\nRateLimiter::for('telegram', function (Request $request) {\n    return Limit::perMinute(60)->by($request->ip());\n});\n\nRateLimiter::for('payment', function (Request $request) {\n    return Limit::perMinute(30)->by($request->ip());\n});\n```\n\n**CORS Configuration:**\n- Disable CORS cho webhook endpoints (khÃ´ng cáº§n)\n\n**Environment Variables Security:**\n- Táº¥t cáº£ sensitive data trong .env\n- Sá»­ dá»¥ng config() helper thay vÃ¬ env() trong code\n- Add .env.example vá»›i placeholders",
      "expected_output": [
        "routes/api.php configured Ä‘áº§y Ä‘á»§",
        "2 middleware classes",
        "Rate limiting configuration",
        "Security headers",
        ".env.example file"
      ]
    },
    
    {
      "step": 9,
      "title": "XÃ¢y Dá»±ng Admin Dashboard (Optional)",
      "prompt": "Táº¡o web-based admin dashboard Ä‘á»ƒ quáº£n lÃ½ vÃ  theo dÃµi:\n\n**Routes (routes/web.php):**\n\n```php\nRoute::prefix('admin')->middleware(['auth', 'admin'])->group(function() {\n    Route::get('/dashboard', [AdminDashboardController::class, 'index']);\n    Route::get('/transactions', [AdminDashboardController::class, 'transactions']);\n    Route::get('/customers', [AdminDashboardController::class, 'customers']);\n    Route::get('/payments', [AdminDashboardController::class, 'payments']);\n    Route::post('/transactions/{id}/approve', [AdminDashboardController::class, 'approve']);\n    Route::post('/transactions/{id}/reject', [AdminDashboardController::class, 'reject']);\n});\n```\n\n**Dashboard Features:**\n\n1. **Overview Page:**\n   - Cards: Tá»•ng doanh thu, Giao dá»‹ch hÃ´m nay, KhÃ¡ch hÃ ng má»›i, Äang chá» duyá»‡t\n   - Chart: Doanh thu 7 ngÃ y gáº§n Ä‘Ã¢y (Chart.js)\n   - Báº£ng: 10 giao dá»‹ch má»›i nháº¥t\n\n2. **Transactions Page:**\n   - DataTable vá»›i filters: status, date range, customer\n   - Columns: ID, Customer, Code, Amount, Status, Created, Actions\n   - Actions: View details, Approve, Reject\n   - Export to Excel\n\n3. **Customers Page:**\n   - DataTable khÃ¡ch hÃ ng\n   - Columns: ID, Username, Balance, Total Transactions, Approved Count, Created\n   - Search by username, chat_id\n   - View customer transaction history\n\n4. **Payments Page:**\n   - DataTable payments\n   - Columns: ID, Customer, Amount, TX Hash, Status, Confirmed At\n   - Link to blockchain explorer\n\n**Authentication:**\n- Laravel Breeze hoáº·c Fortify\n- Simple login form\n- Admin user seeder\n\n**Frontend:**\n- Blade templates\n- Tailwind CSS hoáº·c Bootstrap 5\n- Alpine.js cho interactivity\n- Chart.js cho graphs",
      "expected_output": [
        "AdminDashboardController.php",
        "Blade views: dashboard, transactions, customers, payments",
        "Authentication setup",
        "DataTables integration",
        "Chart.js integration"
      ]
    },
    
    {
      "step": 10,
      "title": "Testing, Logging & Monitoring",
      "prompt": "Implement comprehensive testing, logging vÃ  monitoring:\n\n**1. Unit Tests:**\n\nTáº¡o tests cho:\n- CustomerTest: CRUD operations, balance calculations\n- TransactionTest: Status transitions, validations\n- PaymentServiceTest: Payment generation, confirmation\n- AutoApprovalServiceTest: Auto-approve logic conditions\n\n**2. Feature Tests:**\n\nTáº¡o tests cho:\n- ClientBotControllerTest:\n  - test_start_command_creates_customer()\n  - test_code_input_requires_payment_for_new_customer()\n  - test_code_input_sends_to_admin_for_existing_customer()\n  - test_balance_command_shows_correct_balance()\n\n- AdminBotControllerTest:\n  - test_approve_callback_updates_transaction()\n  - test_reject_callback_notifies_client()\n  - test_approve_deducts_customer_balance()\n\n- PaymentWebhookControllerTest:\n  - test_valid_webhook_confirms_payment()\n  - test_invalid_signature_returns_403()\n  - test_webhook_triggers_admin_notification()\n\n**3. Logging System:**\n\nConfig logging channels (config/logging.php):\n\n```php\n'channels' => [\n    'telegram' => [\n        'driver' => 'daily',\n        'path' => storage_path('logs/telegram.log'),\n        'level' => 'debug',\n        'days' => 14,\n    ],\n    'payment' => [\n        'driver' => 'daily',\n        'path' => storage_path('logs/payment.log'),\n        'level' => 'info',\n        'days' => 30,\n    ],\n    'transaction' => [\n        'driver' => 'daily',\n        'path' => storage_path('logs/transaction.log'),\n        'level' => 'info',\n        'days' => 30,\n    ],\n]\n```\n\nLog events:\n- Customer táº¡o má»›i\n- Transaction status changes\n- Payment confirmations\n- Admin actions\n- Auto-approval events\n- Webhook failures\n- Queue job failures\n\n**4. Monitoring:**\n\nTáº¡o artisan commands:\n\n```php\n// Check pending payments\nphp artisan monitor:pending-payments\n\n// Check failed jobs\nphp artisan monitor:failed-jobs\n\n// Send daily report to admin\nphp artisan report:daily\n```\n\n**5. Error Handling:**\n\n- Global exception handler\n- Custom exceptions: PaymentException, TelegramApiException\n- Friendly error messages cho users\n- Detailed error logs cho developers\n\n**6. Performance Monitoring:**\n\n- Query logging for slow queries\n- Job execution time tracking\n- API response time monitoring",
      "expected_output": [
        "Test suite vá»›i >80% coverage",
        "Logging channels configured",
        "Monitoring commands",
        "Exception handlers",
        "Performance tracking setup"
      ]
    },
    
    {
      "step": 11,
      "title": "Deployment Setup & Documentation",
      "prompt": "Chuáº©n bá»‹ deployment vÃ  documentation hoÃ n chá»‰nh:\n\n**1. Docker Setup:**\n\nTáº¡o docker-compose.yml:\n\n```yaml\nversion: '3.8'\nservices:\n  app:\n    build: .\n    ports:\n      - \"8000:8000\"\n    environment:\n      - DB_HOST=mysql\n      - REDIS_HOST=redis\n    depends_on:\n      - mysql\n      - redis\n  \n  mysql:\n    image: mysql:8.0\n    environment:\n      - MYSQL_DATABASE=telegram_payment\n      - MYSQL_ROOT_PASSWORD=secret\n    volumes:\n      - mysql_data:/var/lib/mysql\n  \n  redis:\n    image: redis:alpine\n    ports:\n      - \"6379:6379\"\n  \n  queue-worker:\n    build: .\n    command: php artisan queue:work redis --tries=3\n    depends_on:\n      - mysql\n      - redis\n\nvolumes:\n  mysql_data:\n```\n\n**2. Deployment Scripts:**\n\nTáº¡o deploy.sh:\n\n```bash\n#!/bin/bash\ngit pull origin main\ncomposer install --no-dev --optimize-autoloader\nphp artisan migrate --force\nphp artisan config:cache\nphp artisan route:cache\nphp artisan view:cache\nphp artisan queue:restart\nsupervisorctl restart laravel-worker:*\n```\n\n**3. Supervisor Configuration:**\n\nTáº¡o laravel-worker.conf:\n\n```ini\n[program:laravel-worker]\nprocess_name=%(program_name)s_%(process_num)02d\ncommand=php /path/to/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600\nautostart=true\nautorestart=true\nstopasgroup=true\nkillasgroup=true\nuser=www-data\nnumprocs=4\nredirect_stderr=true\nstdout_logfile=/path/to/worker.log\nstopwaitsecs=3600\n```\n\n**4. Nginx Configuration:**\n\nTáº¡o nginx.conf cho Laravel:\n\n```nginx\nserver {\n    listen 80;\n    server_name yourdomain.com;\n    root /var/www/html/public;\n\n    add_header X-Frame-Options \"SAMEORIGIN\";\n    add_header X-Content-Type-Options \"nosniff\";\n\n    index index.php;\n\n    location / {\n        try_files $uri $uri/ /index.php?$query_string;\n    }\n\n    location ~ \\.php$ {\n        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;\n        fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;\n        include fastcgi_params;\n    }\n\n    location ~ /\\.(?!well-known).* {\n        deny all;\n    }\n}\n```\n\n**5. SSL Setup (Certbot):**\n\n```bash\nsudo certbot --nginx -d yourdomain.com\n```\n\n**6. Documentation:**\n\nTáº¡o README.md vá»›i:\n- Project overview\n- System requirements\n- Installation steps\n- Configuration guide\n- Telegram bot setup guide\n- Payment gateway setup\n- Webhook setup\n- Testing guide\n- Deployment guide\n- Troubleshooting\n\nTáº¡o API.md vá»›i:\n- Webhook endpoints documentation\n- Payload examples\n- Response formats\n- Error codes\n\n**7. Environment Checklist:**\n\nTáº¡o .env.production.example:\n\n```env\nAPP_ENV=production\nAPP_DEBUG=false\nAPP_URL=https://yourdomain.com\n\nDB_CONNECTION=mysql\nDB_HOST=127.0.0.1\nDB_PORT=3306\nDB_DATABASE=telegram_payment\nDB_USERNAME=root\nDB_PASSWORD=\n\nREDIS_HOST=127.0.0.1\nREDIS_PASSWORD=null\nREDIS_PORT=6379\n\nQUEUE_CONNECTION=redis\n\nTELEGRAM_CLIENT_BOT_TOKEN=\nTELEGRAM_ADMIN_BOT_TOKEN=\nTELEGRAM_ADMIN_CHAT_ID=\n\nUSDT_PAYMENT_API_URL=\nUSDT_PAYMENT_API_KEY=\nUSDT_PAYMENT_WEBHOOK_SECRET=\nUSDT_WALLET_ADDRESS=\n```",
      "expected_output": [
        "docker-compose.yml",
        "deploy.sh script",
        "Supervisor config",
        "Nginx config",
        "README.md comprehensive",
        "API.md documentation",
        ".env.production.example"
      ]
    },
    
    {
      "step": 12,
      "title": "Post-Deployment Setup & Webhooks",
      "prompt": "Táº¡o setup scripts vÃ  commands Ä‘á»ƒ cáº¥u hÃ¬nh sau khi deploy:\n\n**1. Artisan Command: SetupTelegramWebhooks**\n\n```php\nphp artisan telegram:setup-webhooks\n```\n\nCommand logic:\n- Set webhook cho client bot: {APP_URL}/api/telegram/client/webhook\n- Set webhook cho admin bot: {APP_URL}/api/telegram/admin/webhook\n- Set secret token cho má»—i bot\n- Verify webhook URLs accessible\n- Test gá»­i message Ä‘áº¿n admin bot\n- Output success/error messages\n\n**2. Artisan Command: TestPaymentWebhook**\n\n```php\nphp artisan payment:test-webhook\n```\n\nCommand logic:\n- Táº¡o test payment record\n- Generate test webhook payload\n- Sign payload vá»›i secret\n- POST Ä‘áº¿n /api/payment/webhook\n- Verify response vÃ  database changes\n- Cleanup test data\n\n**3. Artisan Command: CreateAdminUser**\n\n```php\nphp artisan admin:create\n```\n\nCommand logic:\n- Prompt for admin email, password, telegram_id\n- Create user vá»›i admin role\n- Output admin dashboard URL\n\n**4. Health Check Endpoint:**\n\nTáº¡o route GET /api/health:\n\n```php\nRoute::get('/health', function() {\n    return response()->json([\n        'status' => 'ok',\n        'database' => DB::connection()->getPdo() ? 'connected' : 'disconnected',\n        'redis' => Redis::connection()->ping() ? 'connected' : 'disconnected',\n        'telegram_client' => app(TelegramClientService::class)->checkConnection(),\n        'telegram_admin' => app(TelegramAdminService::class)->checkConnection(),\n        'queue' => Queue::size('telegram-jobs'),\n    ]);\n});\n```\n\n**5. Monitoring Commands:**\n\n```php\n// Check system status\nphp artisan system:status\n\n// View pending approvals\nphp artisan admin:pending\n\n// Send test notification to admin\nphp artisan admin:test-notify\n```",
      "expected_output": [
        "4 custom artisan commands",
        "Health check endpoint",
        "Webhook setup automation",
        "Testing utilities",
        "Admin user creation tool"
      ]
    }
  ],
  
  "final_deliverables": {
    "code": [
      "Complete Laravel 12 project",
      "12 migration files",
      "4 models with relationships",
      "3 controllers (Client, Admin, Payment)",
      "3 services (TelegramClient, TelegramAdmin, Payment, AutoApproval)",
      "4 queue jobs",
      "6 custom artisan commands",
      "2 middleware classes",
      "Test suite (>80% coverage)",
      "AdminDashboard (optional)"
    ],
    "documentation": [
      "README.md",
      "API.md",
      "DEPLOYMENT.md",
      ".env.example",
      "docker-compose.yml",
      "nginx.conf",
      "supervisor.conf"
    ],
    "features": [
      "âœ… Dual Telegram bots (Client + Admin)",
      "âœ… USDT TRC20 automatic payment",
      "âœ… Webhook-based payment verification",
      "âœ… Admin manual approval system",
      "âœ… Auto-approval cho khÃ¡ch cÅ©",
      "âœ… Balance management",
      "âœ… Transaction history",
      "âœ… Queue jobs vá»›i Redis",
      "âœ… Comprehensive logging",
      "âœ… Admin dashboard (web)",
      "âœ… Health monitoring",
      "âœ… Docker support",
      "âœ… Production-ready deployment"
    ]
  },
  
  "development_timeline": {
    "step_1_2": "1 day - Project setup & database",
    "step_3_4": "2 days - Client bot & payment integration",
    "step_5_6": "2 days - Admin bot & queue jobs",
    "step_7_8": "1 day - Auto-approval & security",
    "step_9": "1 day - Admin dashboard (optional)",
    "step_10_11_12": "1 day - Testing & deployment setup",
    "total": "7-8 days for complete system"
  },
  
  "testing_checklist": [
    "âœ… New customer nháº­p mÃ£ â†’ yÃªu cáº§u náº¡p tiá»n",
    "âœ… Payment webhook â†’ confirm payment â†’ notify admin",
    "âœ… Admin approve â†’ trá»« tiá»n â†’ gá»­i data vá» client",
    "âœ… Admin reject â†’ notify client",
    "âœ… Existing customer nháº­p mÃ£ â†’ auto-approve (náº¿u Ä‘á»§ Ä‘iá»u kiá»‡n)",
    "âœ… Existing customer nháº­p mÃ£ â†’ send to admin (náº¿u khÃ´ng Ä‘á»§ Ä‘iá»u kiá»‡n)",
    "âœ… Balance calculations correct",
    "âœ… Transaction status transitions valid",
    "âœ… Webhook signature verification",
    "âœ… Rate limiting works",
    "âœ… Queue jobs process correctly",
    "âœ… Error handling graceful"
  ]
}